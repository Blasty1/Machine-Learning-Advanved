\documentclass[a4paper]{article}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{xcolor}

\newcommand{\elbo}{\mathcal{L}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\p}{\mathbb{P}}

\title{E1 - Assignment}
\author{
Bruno Carchia \\
\texttt{carchia@kth.se}
\and
Riccardo Alfonso Cerrone \\
  \texttt{cerrone@kth.se}
}

\begin{document}
\maketitle

\begin{align*}
\mathbb{P}(X_2 = x_2 \big | X_4 = \text{thin}) &= \dfrac{\mathbb{P}( X_4 = \text{thin} \big | X_2 = x_2) \mathbb{P}(X_2 = x_2)}{\mathbb{P}(X_4 = \text{thin})}
\\
& \propto \mathbb{P}( X_4 = \text{thin} \big | X_2 = x_2) \mathbb{P}(X_2 = x_2)
\\ 
&= \mathbb{P}( X_4 = \text{thin} \big | X_2 = x_2) \sum_{x_1}\mathbb{P}(X_2 = x_2, X_1=x_1)
\\
&= \mathbb{P}( X_4 = \text{thin} \big | X_2 = x_2) \sum_{x_1}\mathbb{P}(X_2 = x_2 \big| X_1=x_1)\mathbb{P}(X_1=x_1)
\end{align*}

\newpage

\begin{align*}
\mathbb{P}(X_1=x_1 \big | X_3 = \text{medium}, X_4 = \text{thin}) &= \dfrac{\mathbb{P}(X_1=x_1, X_3 = \text{medium}, X_4 = \text{thin})}{\mathbb{P}(X_3 = \text{medium})\mathbb{P}(X_4 = \text{thin} \big | X_3 = \text{medium})}
\\
& \propto \mathbb{P}(X_1=x_1, X_3 = \text{medium}, X_4 = \text{thin})
\\
&= \mathbb{P}(X_1 = x_1) \textcolor{red}{\mathbb{P}(X_3= \text{medium} \big | X_1 = x_1)} \\
& \textcolor{blue}{\mathbb{P}(X_4 = \text{thin} \big | X_3 = \text{medium}, X_1 = x_1)}
\end{align*}

\begin{align*}
\textcolor{blue}{\mathbb{P}(X_4 = \text{T} \big | X_3 = \text{M}, X_1 = x_1)} &= \sum_{x_2} \mathbb{P}(X_4= \text{T}, X_2 = x_2 \big |X_3 = \text{M}, X_1 = x_1) 
\\
&= \sum_{x_2} \mathbb{P}(X_4= \text{T}, X_2 = x_2 \big |X_3 = \text{M}, X_1 = x_1) 
\end{align*}

\newpage

\begin{align*}
\elbo & = \E_q \bigg[ \dfrac{\log \p (x, \mu, \tau)}{\log q (\mu, \tau)} \bigg] \\
&= \E_q [\log \p (x, \mu, \tau)] - \E_q [\log q (\mu, \tau)]\\
&= \textcolor{red}{\E_q [\log \p (\mu | \lambda_0, \mu_0, \tau)]}
+ \textcolor{blue}{\E_q [\log \p (\tau | a_0, b_0)]} 
+ \textcolor{olive}{\E_q [\log \p (D | \mu, \tau)]}
\\ &- \textcolor{orange}{\E_q [\log q (\mu)]} 
- \textcolor{magenta}{\E_q [\log q (\tau)]}
\end{align*}

\begin{align*}
\textcolor{red}{\E_q [\log \p (\mu | \lambda_0, \mu_0, \tau)]}
&= \E \bigg[ \dfrac{1}{2} \log \tau + \dfrac{1}{2} \log \dfrac{\lambda_0}{2 \pi} - \dfrac{1}{2}\lambda_0 \tau (\mu - \mu_0)^2\bigg]
\\
&= \dfrac{1}{2} \log \dfrac{\lambda_0}{2 \pi} + \dfrac{1}{2} \E [\log \tau ] - \dfrac{1}{2}\lambda_0 \E [\tau]\bigg(\E[\mu^2]-2\mu_0\E[\mu]+\mu_0\bigg)
\end{align*}

\begin{align*}
\textcolor{blue}{\E_q [\log \p (\tau | a_0, b_0)]} &= \E[a_0 \log b_0 - \log \Gamma(a_0) + (a_0 -1)\log \tau - b_0 \tau]\\
&= a_0 \log b_0 - \log \Gamma(a_0) + (a_0 -1) \E[\log \tau] - b_0 \E[\tau]
\end{align*}

\begin{align*}
\textcolor{olive}{\E_q [\log \p (D | \mu, \tau)]} &= \E_q \bigg[ \log \bigg(\prod_{n = 1}^{N} \p (x_n | \mu, \tau)\bigg)\bigg]  = \E_q \bigg[ \sum^N_{n = 1} \log \p (x_n | \mu, \tau)\bigg]
\\
&= \sum^N_{n = 1} \E_q \bigg[\log \p (x_n | \mu, \tau)\bigg] 
= \sum^N_{n = 1} \E_q \bigg[\log \bigg(\sqrt{\dfrac{\tau}{2 \pi}} e^{-\frac{\tau}{2}(x_n - \mu)^2}\bigg)\bigg] 
\\
&= \sum^N_{n = 1} \E_q \bigg[ \dfrac{1}{2}\log \tau - \dfrac{1}{2} \log 2 \pi - \dfrac{\tau}{2}(x_n - \mu)^2
\bigg] 
\\
&= \dfrac{N}{2} \log \E_q [\tau] - \dfrac{N}{2} \log 2 \pi - \frac{1}{2} \E_{q(\tau)}[\tau] \sum^N_{n = 1} \E_{q(\mu)}[x_n^2 + \mu^2 -2x_n \mu]
\\
&= \dfrac{N}{2} \log \E_q [\tau] - \dfrac{N}{2} \log 2 \pi - \frac{1}{2} \E_{q(\tau)}[\tau]\bigg(\sum^N_{n = 1} x_n^2-2\E_{q(\mu)}[\mu]\sum^N_{n = 1} x_n+\E_{q(\mu)}[\mu^2]\bigg)
\end{align*}

\begin{align*}
\textcolor{orange}{\E_q [\log q (\mu)]} &= \E_q \bigg[\log \bigg(\sqrt{\dfrac{\lambda_N}{2 \pi}} e^{-\frac{\lambda_N}{2}(\mu - \mu_N)^2}\bigg)\bigg] 
\\
&= \E_q \bigg[ \dfrac{1}{2}\log \dfrac{\lambda_N}{2 \pi} - \dfrac{\lambda_N}{2}(\mu - \mu_N)^2 \bigg] = \dfrac{1}{2}\log \dfrac{\lambda_N}{2 \pi} - \dfrac{\lambda_N}{2} \E_q \bigg[(\mu - \mu_N)^2\bigg]
\\
&= \dfrac{1}{2}\log \dfrac{\lambda_N}{2 \pi} - \dfrac{\lambda_N}{2} \dfrac{1}{\lambda_N}
\\
&= \dfrac{1}{2}\bigg(\log \dfrac{\lambda_N}{2 \pi} - 1\bigg)
\end{align*}

\begin{align*}
\textcolor{magenta}{\E_q [\log q (\tau)]} &= \E[a_N \log b_N - \log \Gamma(a_N) + (a_N -1)\log \tau - b_N \tau]\\
&= a_N \log b_N - \log \Gamma(a_N) + (a_N -1) \E[\log \tau] - b_N \E[\tau]
\end{align*}

\end{document}